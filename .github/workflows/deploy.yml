name: Build and Deploy Portfolio
env:
  CI: false
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * 1' # weekly on Mondays at 12:00 UTC

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    env:
      # Core configuration
      GITHUB_USERNAME: "samehshi"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Feature flags with validation
      USE_GITHUB_DATA: "true"
      USE_MEDIUM_DATA: "false"  # Disabled until username is confirmed
      
      # Optional integrations
      MEDIUM_USERNAME: "sameh_shi"
      
      # Build configuration
      CI: false
      NODE_ENV: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Validate Environment
        run: |
          echo "ğŸ” Validating required environment variables..."
          if [ "$USE_GITHUB_DATA" = "true" ]; then
            if [ -z "$GITHUB_USERNAME" ]; then
              echo "âŒ Error: GITHUB_USERNAME is required when USE_GITHUB_DATA=true"
              exit 1
            fi
            if [ -z "$GITHUB_TOKEN" ]; then
              echo "âŒ Error: GITHUB_TOKEN is required when USE_GITHUB_DATA=true"
              exit 1
            fi
          fi
          
          if [ "$USE_MEDIUM_DATA" = "true" ]; then
            if [ -z "$MEDIUM_USERNAME" ]; then
              echo "âš ï¸ Warning: MEDIUM_USERNAME not set, Medium integration disabled"
              echo "USE_MEDIUM_DATA=false" >> $GITHUB_ENV
            fi
          fi
          
          echo "âœ… Environment validation complete"
          echo "ğŸ“Š Configuration summary:"
          echo "  - GitHub Data: $USE_GITHUB_DATA"
          echo "  - Medium Data: $USE_MEDIUM_DATA"
          echo "  - GitHub Username: $GITHUB_USERNAME"
          echo "  - Medium Username: ${MEDIUM_USERNAME:-'Not set'}"

      - name: Install dependencies
        run: npm ci

      - name: Fetch External Data
        run: |
          echo "ğŸ“¥ Running data fetch script with enhanced error handling..."
          if ! node fetch.js; then
            echo "âš ï¸ Data fetch encountered errors, but continuing with build..."
            echo "This may result in missing GitHub profile or Medium blog data."
          else
            echo "âœ… Data fetch completed successfully"
          fi
          echo "ğŸ“‚ Contents of public directory after fetch:"
          ls -la public/

      - name: Build application
        run: |
          echo "ğŸ› ï¸ Building React application..."
          npm run build
          echo "âœ… React build completed successfully"
          echo "ğŸ“‚ Build output summary:"
          ls -la build/ | head -10
        env:
          CI: false

      - name: Verify Build Quality
        run: |
          echo "ğŸ” Verifying build quality..."
          if [ ! -d "build" ]; then
            echo "âŒ Error: Build directory not found"
            exit 1
          fi
          if [ ! -f "build/index.html" ]; then
            echo "âŒ Error: index.html not found in build directory"
            exit 1
          fi
          BUILD_SIZE=$(du -sh build | cut -f1)
          echo "âœ… Build verification passed"
          echo "ğŸ“Š Build size: $BUILD_SIZE"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Deploy portfolio - ${{ github.sha }}"

      - name: Verify deployment
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Site will be available at: https://samehshi.github.io/portfolio"
          echo "â° Please allow 5-10 minutes for GitHub Pages to update"
          echo "ğŸ“Š Deployment Summary:"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Workflow: ${{ github.workflow }}"
          echo "  - Run ID: ${{ github.run_id }}"
